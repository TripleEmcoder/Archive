#!/bin/sh
#TABUS="10 10 50"
#COUNTS="20 10 50"
#RESETS="5 1 5"
#DISTANCE="2 1 2"
TOOLS=`dirname $0`

tag=$1
shift

for file in $*; do
	file=`basename $file .in`
	offlines=`echo $file | cut -d - -f 1`
	tasks=`echo $file | cut -d - -f 2`

	for distance in $DISTANCE; do
	for tabus in $TABUS; do
	for counts in $COUNTS; do
	for resets in $RESETS; do
		moves=`echo "$tasks*(2*$distance-1)" | bc | cut -d . -f 1`
		tabus2=`echo "$tabus*$moves/100" | bc | cut -d . -f 1`
		counts2=`echo "$counts*$tabus2/100" | bc | cut -d . -f 1`
		resets2=$resets

		command="$TOOLS/tabu $tabus2 $counts2 $resets2 $distance < $file.in > $file.out"
		echo $command >&2
		
		time=`/usr/bin/time -f %U sh -c "$command 2>&-" 2>&1`
		cmax=`cat $file.out | $TOOLS/cmax`
		date=`date +"%F %T"`
		
		echo $tag,$date,$tabus,$counts,$resets,$distance,$cmax,$time >> $file.csv 
		
		rm $file.out
	done
	done
	done
	done
done
